-- =============================================================================
-- НАЗВАНИЕ: Анализ показателей ПСА в целевых медицинских учреждениях
-- ОПИСАНИЕ: Анализирует результаты исследований ПСА у мужчин целевых 
--           возрастных групп (45, 50, 55, 60, 64 лет) в 42 ЛПУ.
--           Возвращает статистику по общему количеству тестов, 
--           количеству превышений (ПСА ≥ 5 нг/мл) и проценту превышений.
--
-- ОСОБЕННОСТИ:
--   • Учитывает только мужчин (SEX = '1')
--   • Фильтрует по целевым возрастным группам
--   • Использует код услуги A09.05.130 (ПСА общий)
--   • Анализирует 42 целевых медицинских учреждения
--   • Защита от деления на ноль при расчете процентов
--
-- ИСПОЛЬЗОВАНИЕ:
--   1. Запустите скрипт в DBeaver.
--   2. В появившемся окне введите:
--        date1 = 01.01.2025   (начало периода)
--        date2 = 31.12.2025   (конец периода)
--   3. Вводите даты БЕЗ кавычек и в формате DD.MM.YYYY.
--
-- ВОЗВРАЩАЕТ: 
--   CODE_LPU          - код ЛПУ
--   Всего_услуг       - общее количество исследований ПСА
--   С_превышением     - количество исследований с ПСА ≥ 5 нг/мл
--   Процент_превышения - процент исследований с превышением
--
-- АВТОР: [Дмитрий Чекуленко / DmitryChekulenko]
-- ДАТА: 2025-01-20
-- =============================================================================

WITH target_lpu AS (
   -- Определяем целевые медицинские учреждения (42 ЛПУ)
   SELECT CODE_LPU
   FROM D_LPU
   WHERE CODE_LPU IN (
       '250100', '250133', '250142', '250191', '250210', '250236',
       '250240', '250244', '250250', '250296', '250322', '250337',
       '250343', '250360', '250366', '250376', '250384', '250391',
       '250396', '250410', '250443', '250452', '250458', '250473',
       '250477', '250495', '250500', '250515', '250525', '250540',
       '250556', '250558', '250560', '250617', '250629', '250632',
       '250634', '250686', '250700', '250701', '250702', '250747'
   )
),
psa_data AS (
   -- Собираем данные по исследованиям ПСА с применением фильтров
   SELECT
       l.CODE_LPU,
       jj.NUM_VALUE
   FROM D_LPU l
   JOIN D_LPU_SERVICES s ON s.LPU = l.ID
   JOIN D_SERVICES ss ON ss.ID = s.SERVICE
   JOIN D_LABMED_RESEARCH r ON r.LPU_SERVICE = s.ID
   JOIN D_LABMED_RESEARCH_METHODS rm ON rm.PID = r.ID
   JOIN D_LABMED_REF_VAL rv ON rv.METHOD = rm.ID
   JOIN D_LABMED_RSRCH_JOURSP jj ON jj.RSRCH_RESREF_VAL = rv.ID
   JOIN D_LABMED_RSRCH_JOUR j ON j.ID = jj.PID
   JOIN D_LABMED_PATJOUR dpj ON dpj.id = j.PATJOUR
   JOIN D_PERSMEDCARD pmc ON pmc.ID = dpj.PATIENT
   JOIN D_AGENTS a ON a.id = pmc.AGENT
   WHERE
       -- Фильтр по целевым ЛПУ
       l.CODE_LPU IN (
           '250100', '250133', '250142', '250191', '250210', '250236',
           '250240', '250244', '250250', '250296', '250322', '250337',
           '250343', '250360', '250366', '250376', '250384', '250391',
           '250396', '250410', '250443', '250452', '250458', '250473',
           '250477', '250495', '250500', '250515', '250525', '250540',
           '250556', '250558', '250560', '250617', '250629', '250632',
           '250634', '250686', '250700', '250701', '250702', '250747'
       )
       -- Код услуги: ПСА общий
       AND ss.SE_CODE = 'A09.05.130'
       -- Период исследования
       AND jj.CONFIRM_DATE BETWEEN TO_DATE('${date1}', 'dd.mm.yyyy')
                               AND TO_DATE('${date2}', 'dd.mm.yyyy') + INTERVAL '1' DAY - INTERVAL '1' SECOND
       -- Только мужчины
       AND a.SEX = '1'
       -- Целевые возрастные группы: 45, 50, 55, 60, 64 лет
       AND (EXTRACT(YEAR FROM jj.CONFIRM_DATE) - EXTRACT(YEAR FROM a.BIRTHDATE)) IN (45, 50, 55, 60, 64)
       -- Исключаем пустые записи
       AND jj.ID IS NOT NULL
)
-- Финальный запрос: агрегация данных по ЛПУ
SELECT
   l.CODE_LPU,
   COUNT(p.NUM_VALUE) AS "Всего_услуг",
   SUM(CASE WHEN p.NUM_VALUE >= 5 THEN 1 ELSE 0 END) AS "С_превышением",
   CASE
       WHEN COUNT(p.NUM_VALUE) = 0 THEN 0
       ELSE ROUND(
           (SUM(CASE WHEN p.NUM_VALUE >= 5 THEN 1 ELSE 0 END) * 100.0) / COUNT(p.NUM_VALUE),
           2
       )
   END AS "Процент_превышения"
FROM target_lpu l
LEFT JOIN psa_data p ON p.CODE_LPU = l.CODE_LPU
GROUP BY l.CODE_LPU
ORDER BY l.CODE_LPU;
